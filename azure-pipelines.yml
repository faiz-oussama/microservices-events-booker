trigger:
  branches:
    include:
    - main
    - develop

pr:
  branches:
    include:
    - main
    - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  dockerRegistryServiceConnection: 'ticketingcr'
  imageRepository: 'ticketing-platform'
  dockerfilePath: '$(Build.SourcesDirectory)'
  tag: '$(Build.BuildId)'
  imagePullSecret: 'ticketing-acr-secret'
  kubernetesServiceConnection: 'ticketing-aks'
  kubernetesNamespace: 'ticketing'
  helmChartPath: '$(Build.SourcesDirectory)/ci-cd/helm/ticketing-chart'

stages:

# ===== BUILD STAGE =====
- stage: Build
  displayName: Build and Push Docker Images
  jobs:
  - job: BuildAndPush
    displayName: Build Docker Images and Push to ACR
    steps:
    
    - task: Docker@2
      displayName: Build and push Discovery Service
      inputs:
        command: buildAndPush
        repository: $(imageRepository)/discovery-service
        dockerfile: $(dockerfilePath)/discovery-service/Dockerfile
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest
    
    - task: Docker@2
      displayName: Build and push API Gateway
      inputs:
        command: buildAndPush
        repository: $(imageRepository)/api-gateway
        dockerfile: $(dockerfilePath)/api-gateway/Dockerfile
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest

    - task: Docker@2
      displayName: Build and push Auth Service
      inputs:
        command: buildAndPush
        repository: $(imageRepository)/auth-service
        dockerfile: $(dockerfilePath)/auth-service/Dockerfile
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest

    - task: Docker@2
      displayName: Build and push Ticket Service
      inputs:
        command: buildAndPush
        repository: $(imageRepository)/ticket-service
        dockerfile: $(dockerfilePath)/ticket-service/Dockerfile
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest

    - task: Docker@2
      displayName: Build and push Event Service
      inputs:
        command: buildAndPush
        repository: $(imageRepository)/event-service
        dockerfile: $(dockerfilePath)/event-service/Dockerfile
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest

    - task: Docker@2
      displayName: Build and push Booking Service
      inputs:
        command: buildAndPush
        repository: $(imageRepository)/booking-service
        dockerfile: $(dockerfilePath)/booking-service/Dockerfile
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest

# ===== TEST STAGE =====
- stage: Test
  displayName: Run Tests
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: RunTests
    displayName: Unit Tests
    steps:
    
    - task: Maven@4
      displayName: Run Maven Tests
      inputs:
        mavenPomFile: '$(Build.SourcesDirectory)/pom.xml'
        goals: 'clean test'
        publishJUnitResults: true
        testResultsFiles: '**/surefire-reports/TEST-*.xml'

# ===== DEPLOY DEV STAGE =====
- stage: DeployDev
  displayName: Deploy to Development
  dependsOn: Test
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
  variables:
    environment: 'development'
    valuesFile: 'values-dev.yaml'
  jobs:
  - deployment: DeployToDev
    displayName: Deploy to AKS (Dev)
    environment: 'ticketing-dev'
    strategy:
      runOnce:
        deploy:
          steps:
          
          - task: KubernetesManifest@0
            displayName: Create Namespace
            inputs:
              action: createSecret
              kubernetesServiceConnection: $(kubernetesServiceConnection)
              namespace: $(kubernetesNamespace)
              secretType: docker-registry
              secretName: $(imagePullSecret)
              dockerRegistryEndpoint: $(dockerRegistryServiceConnection)

          - task: HelmDeploy@0
            displayName: Helm Deploy to Dev
            inputs:
              kubernetesServiceConnection: $(kubernetesServiceConnection)
              namespace: $(kubernetesNamespace)
              command: upgrade
              chartType: FilePath
              chartPath: $(helmChartPath)
              releaseName: ticketing-dev
              overrides: |
                global.image.tag=$(tag)
                environment=dev
                imagePullSecret=$(imagePullSecret)
              valueFile: $(helmChartPath)/$(valuesFile)
              waitForExecution: true

# ===== DEPLOY PRODUCTION STAGE =====
- stage: DeployProd
  displayName: Deploy to Production
  dependsOn: Test
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  variables:
    environment: 'production'
    valuesFile: 'values-azure.yaml'
  jobs:
  - deployment: DeployToProd
    displayName: Deploy to AKS (Prod)
    environment: 'ticketing-prod'
    strategy:
      runOnce:
        deploy:
          steps:
          
          - task: KubernetesManifest@0
            displayName: Create Image Pull Secret
            inputs:
              action: createSecret
              kubernetesServiceConnection: $(kubernetesServiceConnection)
              namespace: $(kubernetesNamespace)
              secretType: docker-registry
              secretName: $(imagePullSecret)
              dockerRegistryEndpoint: $(dockerRegistryServiceConnection)

          - task: HelmDeploy@0
            displayName: Helm Deploy to Production
            inputs:
              kubernetesServiceConnection: $(kubernetesServiceConnection)
              namespace: $(kubernetesNamespace)
              command: upgrade
              chartType: FilePath
              chartPath: $(helmChartPath)
              releaseName: ticketing-platform
              overrides: |
                global.image.tag=$(tag)
                environment=prod
                imagePullSecret=$(imagePullSecret)
              valueFile: $(helmChartPath)/$(valuesFile)
              waitForExecution: true
